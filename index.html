<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-DocuQuest Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden-section { display: none; }
    .nav-btn { transition: all 0.2s; border-bottom: 2px solid transparent; }
    .nav-btn:hover { color: #059669; border-color: #059669; }
    .active-nav { color: #059669; border-color: #059669; font-weight: bold; }
    body { background: radial-gradient(circle at top right, #ecfdf5, #f0fdf4); }
  </style>
</head>
<body class="font-sans text-gray-800 min-h-screen">

  <nav class="bg-white/80 backdrop-blur-md shadow-sm p-4 flex justify-center gap-8 sticky top-0 z-50">
    <button onclick="showSection('request')" id="btn-request" class="nav-btn py-1 active-nav">Request</button>
    <button onclick="showSection('track')" id="btn-track" class="nav-btn py-1">Track Progress</button>
    <button onclick="showSection('admin-login')" id="btn-admin" class="text-gray-400 text-xs mt-1 hover:text-gray-600 transition">Admin Access</button>
  </nav>

  <section id="request" class="max-w-2xl mx-auto py-12 px-4">
    <div class="bg-white rounded-3xl shadow-xl p-8 border-t-8 border-emerald-500 transform transition hover:scale-[1.01]">
      <div class="text-center mb-8">
        <h1 class="text-3xl font-black text-emerald-800">E-DocuQuest</h1>
        <p class="text-emerald-600 font-medium">Bukal National High School</p>
      </div>
      
      <form id="requestForm" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="name" type="text" placeholder="Full Name" class="w-full p-4 bg-gray-50 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none border border-gray-100" required>
          <input id="email" type="email" placeholder="Email Address" class="w-full p-4 bg-gray-50 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none border border-gray-100" required>
        </div>
        <input id="contact" type="text" placeholder="Contact Number (e.g. 09123456789)" class="w-full p-4 bg-gray-50 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none border border-gray-100">
        
        <select id="document" class="w-full p-4 bg-gray-50 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none border border-gray-100" required>
          <option value="">Select Document...</option>
          <option>Form 137 (Permanent Record)</option>
          <option>Form 138 (Report Card)</option>
          <option>Certificate of Good Moral</option>
          <option>Certificate of Graduation</option>
          <option>Request / Transfer Letter</option>
        </select>

        <textarea id="reason" placeholder="Reason for Request" class="w-full p-4 bg-gray-50 rounded-xl focus:ring-2 focus:ring-emerald-400 outline-none border border-gray-100" rows="3" required></textarea>
        
        <button type="submit" id="submitBtn" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-emerald-700 transition-all shadow-lg active:scale-95">Submit Request</button>
      </form>
      <div id="requestFeedback" class="mt-6"></div>
    </div>
  </section>

  <section id="track" class="hidden-section max-w-xl mx-auto py-12 px-4">
    <div class="bg-white rounded-3xl shadow-xl p-8 text-center">
      <h2 class="text-2xl font-bold mb-2">Track Your Document</h2>
      <p class="text-gray-500 mb-6 italic text-sm text-center">Enter your Tracking ID below</p>
      
      <input id="trackId" type="text" placeholder="BNHS-XXXXX" class="w-full p-4 bg-gray-50 rounded-xl border mb-4 text-center font-mono text-xl uppercase tracking-widest outline-none focus:border-emerald-500">
      <button onclick="handleTrack()" id="trackBtn" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 transition">Check Status</button>
      
      <div id="trackDisplay" class="hidden-section mt-10 p-6 bg-emerald-50 rounded-2xl border border-emerald-100">
        <div class="w-full bg-gray-200 rounded-full h-4 mb-6 overflow-hidden">
          <div id="trackBar" class="bg-emerald-500 h-full transition-all duration-1000" style="width: 0%"></div>
        </div>
        <p class="text-gray-500 text-xs uppercase tracking-widest mb-1">Current Status</p>
        <p id="trackStatusText" class="text-3xl font-black text-emerald-800 italic uppercase"></p>
      </div>
    </div>
  </section>

  <section id="admin-login" class="hidden-section max-w-sm mx-auto py-12 px-4">
    <div class="bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
      <h2 class="text-xl font-bold mb-4 text-center text-gray-800">Admin Portal Login</h2>
      <input id="adminEmail" type="email" placeholder="Email" class="w-full p-3 border rounded-lg mb-3 outline-none focus:border-emerald-500">
      <input id="adminPass" type="password" placeholder="Password" class="w-full p-3 border rounded-lg mb-4 outline-none focus:border-emerald-500">
      <button onclick="handleAdminLogin()" id="loginBtn" class="w-full bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-black transition">Verify Credentials</button>
    </div>
  </section>

  <section id="admin-panel" class="hidden-section max-w-6xl mx-auto py-12 px-4">
    <div class="bg-white p-6 rounded-2xl shadow-2xl">
      <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Request Dashboard</h2>
          <p class="text-sm text-gray-500" id="recordCount">Total Requests: 0</p>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
          <input type="text" id="adminSearch" onkeyup="filterTable()" placeholder="Search Name or ID..." class="p-2 border rounded-lg w-full md:w-64 outline-none focus:ring-2 focus:ring-emerald-300">
          <button onclick="loadAdminData()" class="bg-emerald-100 text-emerald-700 p-2 px-3 rounded-lg hover:bg-emerald-200 transition" title="Refresh Data">ðŸ”„ Refresh</button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
          <thead>
            <tr class="bg-emerald-600 text-white">
              <th class="p-4 rounded-tl-lg">ID</th>
              <th class="p-4">Student Info</th>
              <th class="p-4">Document Type</th>
              <th class="p-4 text-center">Status</th>
              <th class="p-4 rounded-tr-lg text-center">Update</th>
            </tr>
          </thead>
          <tbody id="adminTableBody" class="text-sm">
            </tbody>
        </table>
      </div>
    </div>
  </section>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzNq_pNzkjqME0-myMHUh2ixiOxhdbrzGXiaUCo-REr-jjhcYOf1XCvpr4ey6z2P_mQ/exec"; 

    function showSection(id) {
      document.querySelectorAll('section').forEach(s => s.classList.add('hidden-section'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
      
      document.getElementById(id).classList.remove('hidden-section');
      const navBtn = document.getElementById('btn-' + id);
      if(navBtn) navBtn.classList.add('active-nav');
    }

    // SUBMIT REQUEST
    document.getElementById('requestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('submitBtn');
      const feedback = document.getElementById('requestFeedback');
      
      btn.disabled = true;
      btn.innerText = "Connecting to BNHS Server...";

      const trackingId = "BNHS-" + Math.floor(10000 + Math.random() * 90000);
      const payload = {
        action: "submit",
        trackingId: trackingId,
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        contact: document.getElementById('contact').value,
        document: document.getElementById('document').value,
        reason: document.getElementById('reason').value
      };

      try {
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        feedback.innerHTML = `
          <div class="bg-emerald-600 p-6 rounded-2xl text-white text-center shadow-lg transform transition animate-pulse">
            <p class="font-bold text-lg">Request Sent Successfully!</p>
            <p class="text-4xl font-mono my-2 tracking-widest select-all">${trackingId}</p>
            <p class="text-[10px] opacity-80 uppercase font-bold">Copy or Screenshot this ID now</p>
          </div>`;
        document.getElementById('requestForm').reset();
      } catch (err) {
        alert("Submission failed. Please check your internet connection.");
      }
      btn.disabled = false; 
      btn.innerText = "Submit Request";
    });

    // TRACK STATUS
    async function handleTrack() {
      const id = document.getElementById('trackId').value.trim().toUpperCase();
      if(!id) return alert("Please enter a Tracking ID");

      const btn = document.getElementById('trackBtn');
      btn.innerText = "Searching Records...";
      
      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "track", trackingId: id}) });
        const data = await res.json();

        if (data.status === "Not Found") {
          alert("Tracking ID not found. Ensure the ID is correct.");
          btn.innerText = "Check Status";
          return;
        }
        
        document.getElementById('trackDisplay').classList.remove('hidden-section');
        document.getElementById('trackStatusText').innerText = data.status;
        
        let p = 10;
        if(data.status === "Processing") p = 35;
        if(data.status === "Ready for Pickup") p = 70;
        if(data.status === "Received") p = 100;
        
        document.getElementById('trackBar').style.width = p + "%";
      } catch (e) {
        alert("Unable to reach the tracking system.");
      }
      btn.innerText = "Check Status";
    }

    // ADMIN LOGIN
    async function handleAdminLogin() {
      const email = document.getElementById('adminEmail').value.trim();
      const password = document.getElementById('adminPass').value;
      const btn = document.getElementById('loginBtn');
      
      btn.innerText = "Verifying...";
      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "login", email, password}) });
        const auth = await res.text();
        
        if (auth === "authorized") {
          showSection('admin-panel');
          loadAdminData();
        } else {
          alert("Access Denied: Invalid credentials.");
          btn.innerText = "Verify Credentials";
        }
      } catch (e) {
        alert("Login failed. Check your connection.");
        btn.innerText = "Verify Credentials";
      }
    }

    // ADMIN LOAD DATA
    async function loadAdminData() {
      const body = document.getElementById('adminTableBody');
      const countLabel = document.getElementById('recordCount');
      body.innerHTML = "<tr><td colspan='5' class='p-10 text-center text-gray-400'>Loading data from Google Sheets...</td></tr>";
      
      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "loadAll"}) });
        const data = await res.json();
        
        countLabel.innerText = `Total Requests: ${data.length}`;
        body.innerHTML = "";
        data.reverse().forEach(row => {
          const statusClass = row[6] === "Received" ? "bg-gray-100 text-gray-600" : (row[6] === "Ready for Pickup" ? "bg-emerald-100 text-emerald-700" : "bg-blue-100 text-blue-700");
          
          body.innerHTML += `
            <tr class="border-b hover:bg-emerald-50 transition admin-row">
              <td class="p-4 font-mono font-bold text-xs">${row[0]}</td>
              <td class="p-4">
                <div class="font-bold">${row[2]}</div>
                <div class="text-[10px] text-gray-400 font-mono">${row[3]} | ${row[7] || 'N/A'}</div>
              </td>
              <td class="p-4 text-[11px] font-medium">${row[4]}</td>
              <td class="p-4 text-center">
                <span class="px-3 py-1 rounded-full font-bold text-[10px] uppercase ${statusClass}">${row[6]}</span>
              </td>
              <td class="p-4 text-center">
                <select onchange="updateStatus('${row[0]}', this.value)" class="text-[11px] border border-gray-200 p-2 rounded-lg bg-white outline-none focus:ring-2 focus:ring-emerald-300">
                  <option value="">Update Status</option>
                  <option value="Processing">Processing</option>
                  <option value="Ready for Pickup">Ready for Pickup</option>
                  <option value="Received">Received</option>
                </select>
              </td>
            </tr>`;
        });
      } catch (e) {
        body.innerHTML = "<tr><td colspan='5' class='p-10 text-center text-red-400'>Error loading data.</td></tr>";
      }
    }

    // SEARCH FILTER
    function filterTable() {
      const input = document.getElementById("adminSearch").value.toUpperCase();
      const rows = document.querySelectorAll(".admin-row");
      rows.forEach(row => {
        row.style.display = row.innerText.toUpperCase().includes(input) ? "" : "none";
      });
    }

    // ADMIN UPDATE
    async function updateStatus(tid, newStatus) {
      if (!newStatus) return;
      const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "update", trackingId: tid, newStatus}) });
      if(await res.text() === "Updated") {
        loadAdminData();
      } else {
        alert("Failed to update status.");
      }
    }
  </script>
</body>
</html>
